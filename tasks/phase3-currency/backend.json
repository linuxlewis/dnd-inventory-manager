{
  "project": "D&D Party Inventory Manager",
  "branchName": "feat/currency-backend",
  "description": "Backend API for currency management with add, spend, and convert operations",
  "userStories": [
    {
      "id": "BE-013",
      "title": "Currency Pydantic schemas",
      "description": "As a developer, I need Pydantic v2 models for currency API request/response validation.",
      "acceptanceCriteria": [
        "Create backend/app/models/currency.py",
        "CurrencyDenomination enum: copper, silver, gold, platinum",
        "CurrencyUpdate schema: copper (int, optional), silver (int, optional), gold (int, optional), platinum (int, optional), note (str, optional)",
        "CurrencyConvert schema: from_denomination (CurrencyDenomination), to_denomination (CurrencyDenomination), amount (int, ge=1)",
        "CurrencyResponse schema: copper (int), silver (int), gold (int), platinum (int), total_gp (float)",
        "All schemas use Pydantic v2 syntax",
        "ruff check passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "total_gp is computed: (copper/100) + (silver/10) + gold + (platinum*10)"
    },
    {
      "id": "BE-014",
      "title": "Currency service layer",
      "description": "As a developer, I need a service that handles currency business logic and validation.",
      "acceptanceCriteria": [
        "Create backend/app/services/currency.py",
        "CONVERSION_RATES constant: { 'copper': 1, 'silver': 10, 'gold': 100, 'platinum': 1000 }",
        "calculate_total_gp(copper, silver, gold, platinum) -> float function",
        "validate_sufficient_funds(inventory, delta) -> bool function",
        "apply_currency_delta(inventory, delta) -> CurrencyResponse function",
        "convert_currency(inventory, from_denom, to_denom, amount) -> CurrencyResponse function",
        "Conversion validates sufficient source funds",
        "Conversion handles all direction conversions (up-convert and down-convert)",
        "ruff check passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Conversion rates: 10 CP = 1 SP, 10 SP = 1 GP, 10 GP = 1 PP"
    },
    {
      "id": "BE-015",
      "title": "Get currency endpoint",
      "description": "As a user, I want to retrieve my current treasury balance.",
      "acceptanceCriteria": [
        "Create backend/app/routers/currency.py",
        "GET /api/inventories/{slug}/currency endpoint",
        "Returns CurrencyResponse with all denominations and total_gp",
        "Requires X-Passphrase header authentication",
        "Returns 401 for invalid/missing passphrase",
        "Returns 404 for unknown inventory slug",
        "Register router in main.py",
        "ruff check passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "BE-016",
      "title": "Update currency endpoint",
      "description": "As a user, I want to add or spend currency from my treasury.",
      "acceptanceCriteria": [
        "POST /api/inventories/{slug}/currency endpoint",
        "Request body: CurrencyUpdate (copper, silver, gold, platinum, note - all optional)",
        "Positive values add funds, negative values spend",
        "Validates sufficient funds for any negative delta",
        "Returns 400 with clear message if insufficient funds",
        "Returns updated CurrencyResponse on success",
        "Broadcasts SSE 'currency_updated' event to all connected clients",
        "Requires X-Passphrase authentication",
        "ruff check passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Delta-based updates prevent race conditions"
    },
    {
      "id": "BE-017",
      "title": "Convert currency endpoint",
      "description": "As a user, I want to convert currency between denominations.",
      "acceptanceCriteria": [
        "POST /api/inventories/{slug}/currency/convert endpoint",
        "Request body: CurrencyConvert (from_denomination, to_denomination, amount)",
        "Applies conversion rates: 10 CP = 1 SP, 10 SP = 1 GP, 10 GP = 1 PP",
        "Handles up-conversion (e.g., 100 CP -> 1 GP) and down-conversion (e.g., 1 GP -> 10 SP)",
        "Validates sufficient funds in source denomination",
        "Returns 400 if insufficient funds or invalid conversion",
        "Returns updated CurrencyResponse on success",
        "Broadcasts SSE 'currency_updated' event",
        "Requires X-Passphrase authentication",
        "ruff check passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Down-conversion always succeeds if source funds exist. Up-conversion may leave remainder."
    },
    {
      "id": "BE-018",
      "title": "Currency endpoint tests",
      "description": "As a developer, I need comprehensive tests for currency functionality.",
      "acceptanceCriteria": [
        "Create backend/tests/test_currency.py",
        "Test get currency returns correct values",
        "Test add currency increases balance",
        "Test spend currency decreases balance",
        "Test insufficient funds returns 400",
        "Test conversion between all denomination pairs",
        "Test conversion with insufficient funds returns 400",
        "Test authentication required for all endpoints",
        "All tests pass with pytest",
        "ruff check passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Use pytest-asyncio for async endpoint tests"
    }
  ]
}
